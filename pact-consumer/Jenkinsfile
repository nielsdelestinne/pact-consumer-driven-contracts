pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                withMaven(maven: 'mvn') {
                    sh '''
                        cd pact-consumer
                        mvn clean install -DskipTests
                    '''
                }
            }
        }
        stage('Test') {
            steps {
                withMaven(maven: 'mvn') {
                    sh '''
                        cd pact-consumer
                        mvn test
                    '''
                }
            }
        }
        stage('Publish Pact') {
            steps {
                withMaven(maven: 'mvn') {
                    def releaseVersion = "${sh(returnStdout: true, script: "git rev-list HEAD --count").trim()}"
                    def consumerVersion = "${releaseVersion}-${env.GIT_COMMIT.substring(0, 7)}"
                    sh """
                        cd pact-consumer
                        mvn pact:publish -Dpact-broker.url=http://broker_app:9292 -Dconsumer-application.version=${consumerVersion} -Dpact.tag=${env.GIT_BRANCH}
                    """
                }
            }
        }
    }
}